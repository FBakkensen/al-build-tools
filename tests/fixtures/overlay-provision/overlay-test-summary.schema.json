{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/FBakkensen/al-build-tools/schemas/overlay-test-summary.schema.json",
  "title": "Overlay Test Summary",
  "description": "JSON Schema for overlay provision test harness summary output (test-overlay-build.ps1)",
  "type": "object",
  "required": [
    "image",
    "startTime",
    "endTime",
    "durationSeconds",
    "exitCode",
    "success",
    "psVersion",
    "dotnetSdkVersion",
    "overlaySource",
    "scenarioResults",
    "testedScripts",
    "cacheLocations",
    "transcriptPath"
  ],
  "properties": {
    "image": {
      "type": "string",
      "description": "Full Docker image reference used for testing",
      "examples": [
        "mcr.microsoft.com/dotnet/sdk:8.0-windowsservercore-ltsc2022"
      ]
    },
    "imageDigest": {
      "type": "string",
      "description": "Hashed image ID or digest (first 16 characters)",
      "examples": [
        "sha256:abcd1234",
        "f1e2d3c4b5a6"
      ]
    },
    "containerId": {
      "type": "string",
      "description": "Container name or ID used during test execution",
      "examples": [
        "albt-overlay-test-a1b2c3d4"
      ]
    },
    "startTime": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of test harness start (UTC)",
      "examples": [
        "2025-10-20T14:30:00.000Z"
      ]
    },
    "endTime": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of test harness completion (UTC)",
      "examples": [
        "2025-10-20T14:45:30.000Z"
      ]
    },
    "durationSeconds": {
      "type": "integer",
      "minimum": 0,
      "description": "Total test execution duration in seconds",
      "examples": [
        930
      ]
    },
    "exitCode": {
      "type": "integer",
      "description": "Final exit code of test harness (0=success, 1=general error, 6=missing tool)",
      "enum": [0, 1, 6],
      "examples": [
        0,
        1,
        6
      ]
    },
    "success": {
      "type": "boolean",
      "description": "Overall test success indicator (true if exitCode=0)"
    },
    "psVersion": {
      "type": "string",
      "description": "PowerShell version used inside container",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "examples": [
        "7.4.0",
        "7.2.3"
      ]
    },
    "dotnetSdkVersion": {
      "type": "string",
      "description": ".NET SDK version from container base image",
      "examples": [
        "8.0",
        "8.0.100"
      ]
    },
    "overlaySource": {
      "type": "string",
      "enum": ["local", "github"],
      "description": "Source of overlay files tested (local=mounted from host, github=downloaded release)"
    },
    "scenarioResults": {
      "type": "array",
      "description": "Provision test scenario results",
      "items": {
        "type": "object",
        "required": [
          "scenarioId",
          "name",
          "passed",
          "validationDetails"
        ],
        "properties": {
          "scenarioId": {
            "type": "integer",
            "minimum": 1,
            "description": "Scenario number (1-based index)",
            "examples": [1, 2, 3]
          },
          "name": {
            "type": "string",
            "description": "Scenario descriptive name",
            "examples": [
              "No dependencies property",
              "Empty dependencies array",
              "With dependency"
            ]
          },
          "passed": {
            "type": "boolean",
            "description": "Scenario pass/fail indicator"
          },
          "durationSeconds": {
            "type": "integer",
            "minimum": 0,
            "description": "Scenario execution duration in seconds"
          },
          "validationDetails": {
            "type": "array",
            "description": "Step-by-step validation results for this scenario",
            "items": {
              "type": "object",
              "required": [
                "step",
                "passed"
              ],
              "properties": {
                "step": {
                  "type": "string",
                  "description": "Validation step description",
                  "examples": [
                    "Provision exit code 0",
                    "Baseline BC packages downloaded",
                    "9altitudes package downloaded"
                  ]
                },
                "passed": {
                  "type": "boolean",
                  "description": "Step pass/fail indicator"
                }
              }
            }
          }
        }
      }
    },
    "testedScripts": {
      "type": "array",
      "description": "List of overlay scripts tested",
      "items": {
        "type": "string",
        "examples": [
          "download-compiler.ps1",
          "download-symbols.ps1"
        ]
      }
    },
    "cacheLocations": {
      "type": "object",
      "description": "Cache directory paths used during testing",
      "required": [
        "toolCache",
        "symbolCache"
      ],
      "properties": {
        "toolCache": {
          "type": "string",
          "description": "AL compiler tool cache directory",
          "examples": [
            "~/.bc-tool-cache",
            "C:\\Users\\ContainerUser\\.bc-tool-cache"
          ]
        },
        "symbolCache": {
          "type": "string",
          "description": "BC symbol package cache directory",
          "examples": [
            "~/.bc-symbol-cache",
            "C:\\Users\\ContainerUser\\.bc-symbol-cache"
          ]
        }
      }
    },
    "transcriptPath": {
      "type": "string",
      "description": "Path to PowerShell transcript file (relative to output directory)",
      "examples": [
        "out/test-overlay/overlay.transcript.txt"
      ]
    },
    "phases": {
      "type": "object",
      "description": "Optional timing breakdown for test phases",
      "properties": {
        "imagePullSeconds": {
          "type": "integer",
          "minimum": 0,
          "description": "Docker image pull duration"
        },
        "containerCreateSeconds": {
          "type": "integer",
          "minimum": 0,
          "description": "Container creation and execution duration"
        },
        "testExecuteSeconds": {
          "type": "integer",
          "minimum": 0,
          "description": "Overlay test script execution duration"
        }
      }
    },
    "errorSummary": {
      "type": "string",
      "description": "Human-readable error summary (present only on failure)",
      "examples": [
        "Provision tests failed: Scenario 1, Scenario 3",
        "Overlay mount validation failed"
      ]
    }
  }
}
